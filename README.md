# Cobra Verifier

Cobra verifier is a component of the [Cobra project](https://github.com/DBCobra/CobraHome).
Cobra verifier checks [serializability](https://en.wikipedia.org/wiki/Serializability) of a set of transactions (called history). The Cobra paper [[1]](#cobrapaper) defines the problem and gives context.

How to install and run Cobra verifier
---

The following steps build Cobra verifier and run it on existing histories or the histories generated by [Cobra bench](https://github.com/DBCobra/CobraBench).

Cobra verifier requires a NVIDIA GPU and a corresponding environment (GPU drivers, libraries, and a NVCC compiler), for example an AWS EC2 `p3.2xlarge` instance with `Deep Learning Base AMI (Ubuntu 18.04)`.

This tutorial has been tested on Ubuntu 18.04,
Java v1.8.0, and CUDA v10.0.130.


### Step 0: Setup environment

Please see the README in [CobraHome](https://github.com/DBCobra/CobraHome) and
run its commands to prepare Cobra's environment.


### <a name="step1"/> Step 1: Build Cobra verifier



Install required packages:

    $ sudo apt install libgmpxx4ldbl maven wcstools
    

Add [MonoSAT](http://www.cs.ubc.ca/labs/isd/Projects/monosat/) as a library:

    $ cd $COBRA_HOME/CobraVerifier/
    $ mvn install:install-file -Dfile=./monosat/monosat.jar -DgroupId=monosat \
      -DartifactId=monosat -Dversion=1.4.0 -Dpackaging=jar -DgeneratePom=true

Build Cobra verifier:

    $ ./run.sh build

Now ensure that the verifier built successfully:

    $ ./run.sh mono audit RANDOMSTRING
    
The verifier should produce an error message:

> [ERROR] Config file \<RANDOMSTRING\> not found

### <a name="step2" /> Step 2: Run Cobra verifier

Cobra verifier has two modes for checking serializability:

  * **One-shot verification**: load the history as a whole and run Cobra's verification algorithm
  * **Verification in rounds**: load a subset of the history, run the verification algorithm on the subset, garbage collect outdated transactions, and load more transactions from the history

#### (i) one-shot verification

Run the verifier in one-shot mode:

    $ ./run.sh mono audit ./cobra.conf.default [history]
    # for example, replace [history] with ./CobraLogs/one-shot-10k/twitter-10000/

The `[history]` is a history folder; you can get a history from either [CobraLogs](https://github.com/DBCobra/CobraLogs) or running [Cobra bench](https://github.com/DBCobra/CobraBench).
    
#### (ii) verification in rounds

Run the verifier in rounds mode:

    $ ./run.sh mono continue ./cobra.conf.default [history]
    # for example, replace [history] with ./CobraLogs/scaling/twitter-100000/
    
Note that verification in rounds needs _fence transactions_ which are synchronization transactions issued by database clients.
This requires that the history is generated by [Cobra bench](https://github.com/DBCobra/CobraBench),
whose database library issues fence transactions.


Reproduce results
---

In the Cobra paper [[1]](#cobrapaper), we experiment with the verifier on various workloads, and compare it with different baselines.
To reproduce Figures 5-9 in Section 6.1 and 6.2, please see [instructions to reproduce experiments](reproduce_results.md).



Troubleshooting
---

#### Exception in thread "main" java.lang.UnsatisfiedLinkError: no gpumm in java.library.path

This exception means that Cobra's GPU library is not correctly built or linked. Please run the commands below and look for error messages.

    $ cd $COBRA_HOME/CobraVerifier/
    $ ./run.sh build

#### <a name="OOM" /> CUDA: out of memory

There are three reasons why Cobra verifier reports this error. 

* Another Cobra verifier instance is running. Please stop the running verifier instance before launching another.

* The current task requires more GPU memory than the default allocation. You can allocate more GPU memory to Cobra by updating the file `$COBRA_HOME/CobraVerifier/include/gpu_GPUmm.cu` line 34 (`#define MAX_N 30000ul`) to a larger number (say `38000ul`), and rebuild the verifier (`./run.sh build`).

* The required GPU memory exceeds the physical GPU memory. In this case, Cobra cannot verify this history with the current GPU. 


<a name="cobrapaper" /> Reference
---

[1] Cheng Tan, Changgeng Zhao, Shuai Mu, and Michael Walfish. Cobra: Making Transactional Key-Value Stores Verifiably Serializable. OSDI 2020.




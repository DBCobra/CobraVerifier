# Cobra Verifier

Cobra verifier is a (research) system that checks [serializability](https://en.wikipedia.org/wiki/Serializability) of a transaction history. Cobra paper (to appear) defines the problem and gives context.

How to install and run Cobra verifier
---

The following steps build Cobra verifier and introduce how to run Cobra verifier on existing transaction histories (see [CobraLogs](https://github.com/DBCobra/CobraLogs)) or the workloads that one newly generates (see [CobraBench](https://github.com/DBCobra/CobraBench)).

Cobra verifier requires a NVIDIA GPU and a corresponding environment (GPU drivers, libraries, and a NVCC compiler). 

The commands in this tutorial have been tested on Ubuntu 16.04,
Java v1.8.0, and CUDA Version 10.0.130.


### Step 0: Setup environment

Please see README in [CobraHome](https://github.com/DBCobra/CobraHome) and prepare Cobra's environment.

    $ cd PATH/TO/CobraHome/ 
    $ . ./env.sh


### <a name="step1"/> Step 1: Build and install



Install required packages:

    $ sudo apt-get install libgmpxx4ldbl maven wcstools
    

Add MonoSAT as a library:

    $ cd $COBRA_HOME/CobraVerifier/
    $ mvn install:install-file -Dfile=./monosat/monosat.jar -DgroupId=monosat \
      -DartifactId=monosat -Dversion=1.4.0 -Dpackaging=jar -DgeneratePom=true

Build Cobra verifier:

    $ ./run.sh build
    
If you successfully built the verifier, when you run:

    $ ./run.sh mono audit randomstring
    
The verifier should produce an error message:

> [ERROR] Config file \<randomstring\> not found

### <a name="step2" /> Step 2: Run Cobra verifier

Cobra verifier has two modes for checking serializability:

  * **One-shot verification**: load the entire history as a whole and run Cobra's verification algorithm
  * **Verification in rounds**: load a subset of the history, run the verification algorithm on the subset, garbage collect outdated transactions, and load more transactions from the history

#### (i) one-shot verification

Run the verifier in one-shot verification:

    $ ./run.sh mono audit ./cobra.conf.default <history-dir>

The `<history-dir>` is the folder of a history; one can get a history from either [CobraLogs](https://github.com/DBCobra/CobraLogs) or running [CobraBench](https://github.com/DBCobra/CobraBench).
    
#### (ii) verification in rounds

Run the verifier in verification in rounds:

    $ ./run.sh mono continue ./cobra.conf.default <history-dir>
    
Note that verification in rounds needs _fence transactions_ which are synchronization transactions issued by database clients.
This requires the history are generated by [CobraBench](https://github.com/DBCobra/CobraBench),
whose database library issues fence transactions.


Reproduce results
---

In Cobra paper (to appear), we experiment Cobra verifier on various workloads and compare it with different baselines.
To reproduce these results, please see [instructions to reproduce experiments](reproduce_results.md).



Troubleshooting
---

#### "Exception in thread "main" java.lang.UnsatisfiedLinkError: no gpumm in java.library.path"

This exception means that Cobra's GPU library is not correctly built or linked. Please re-run built cmd below and looking for error messages.

    $ ./run.sh build

#### "CUDA: out of memory"

There are three reasons why Cobra verifier reports this error. 

* Another Cobra verifier instance is still running. Stop one instance before running another.

* Checking the given history requires more GPU memory than the default allocation in our configuration. One can increase the parameter `#define MAX_N 16384ul` in file `$COBRA_HOME/CobraVerifier/include/gpu_GPUmm.cu` to allocate more GPU memory, and rebuild the verifier (`./run.sh build`).

* The required GPU memory exceeds the physical GPU memory. In this case, Cobra cannot verify this history on the current GPU. 






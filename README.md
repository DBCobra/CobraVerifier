# Cobra Verifier

Cobra verifier is a component of [Cobra project](https://github.com/DBCobra/CobraHome).
Cobra verifier checks [serializability](https://en.wikipedia.org/wiki/Serializability) of a set of transactions (called history). Cobra paper (to appear) defines the problem and gives context.

How to install and run Cobra verifier
---

The following steps build Cobra verifier and introduce how to run Cobra verifier on existing histories (see [CobraLogs](https://github.com/DBCobra/CobraLogs)) or the histories generated by [Cobra bench](https://github.com/DBCobra/CobraBench).

Cobra verifier requires a NVIDIA GPU and a corresponding environment (GPU drivers, libraries, and a NVCC compiler).

This tutorial have been tested on Ubuntu 18.04,
Java v1.8.0, and CUDA v10.0.130.


### Step 0: Setup environment

Please see [CobraHome](https://github.com/DBCobra/CobraHome) and prepare Cobra's environment.

    $ cd PATH/TO/CobraHome/ 
    $ . ./env.sh


### <a name="step1"/> Step 1: Build Cobra verifier



Install required packages:

    $ sudo apt install libgmpxx4ldbl maven wcstools
    

Add [MonoSAT](http://www.cs.ubc.ca/labs/isd/Projects/monosat/) as a library:

    $ cd $COBRA_HOME/CobraVerifier/
    $ mvn install:install-file -Dfile=./monosat/monosat.jar -DgroupId=monosat \
      -DartifactId=monosat -Dversion=1.4.0 -Dpackaging=jar -DgeneratePom=true

Build Cobra verifier:

    $ ./run.sh build
    
If the verifier is successfully built, run:

    $ ./run.sh mono audit RANDOMSTRING
    
The verifier should produce an error message:

> [ERROR] Config file \<RANDOMSTRING\> not found

### <a name="step2" /> Step 2: Run Cobra verifier

Cobra verifier has two modes for checking serializability:

  * **One-shot verification**: load the entire history as a whole and run Cobra's verification algorithm
  * **Verification in rounds**: load a subset of the history, run the verification algorithm on the subset, garbage collect outdated transactions, and load more transactions from the history

#### (i) one-shot verification

Run Cobra's one-shot verification:

    $ ./run.sh mono audit ./cobra.conf.default <history-dir>

The `<history-dir>` is the folder of a history; one can get a history from either [CobraLogs](https://github.com/DBCobra/CobraLogs) or running [Cobra bench](https://github.com/DBCobra/CobraBench).
    
#### (ii) verification in rounds

Run Cobra's verification in rounds:

    $ ./run.sh mono continue ./cobra.conf.default <history-dir>
    
Note that verification in rounds needs _fence transactions_ which are synchronization transactions issued by database clients.
This requires the history is generated by [Cobra bench](https://github.com/DBCobra/CobraBench),
whose database library issues fence transactions.


Reproduce results
---

In Cobra paper (to appear), we experiment the verifier on various workloads and compare it with different baselines.
To reproduce these results, please see [instructions to reproduce experiments](reproduce_results.md).



Troubleshooting
---

#### Exception in thread "main" java.lang.UnsatisfiedLinkError: no gpumm in java.library.path

This exception means that Cobra's GPU library is not correctly built or linked. Please run the commands below and look for error messages.

    $ cd $COBRA_HOME/CobraVerifier/
    $ ./run.sh build

#### <a name="OOM" /> CUDA: out of memory

There are three reasons why Cobra verifier reports this error. 

* Another Cobra verifier instance is running. Please stop the running verifier instance before launching another.

* Current task requires more GPU memory than the default allocation. One can allocate more GPU memory to Cobra by updating file `$COBRA_HOME/CobraVerifier/include/gpu_GPUmm.cu` line 34 (`#define MAX_N 30000ul`) to a larger number (say `38000ul`), and rebuild the verifier (`./run.sh build`).

* The required GPU memory exceeds the physical GPU memory. In this case, Cobra cannot verify this history with the current GPU. 





